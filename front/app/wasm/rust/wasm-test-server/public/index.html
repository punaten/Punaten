<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chroma Key Composition with FFmpeg wasm</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 20px;
    }
  </style>
</head>

<body>
  <h3>Upload a static image and a green screen video to compose!</h3>
  <input type="file" id="image-uploader" accept="image/*"><br>
  <input type="file" id="video-uploader" accept="video/*"><br>
  <button id="compose">Compose</button>
  <video id="output-video" controls muted autoplay></video>
  <script type="module">
    import { FFmpeg } from "@ffmpeg/ffmpeg";
    import { fetchFile, toBlobURL } from "@ffmpeg/util"; ïï
    const {
      createFFmpeg
    } = FFmpeg;
    const ffmpeg = createFFmpeg({
      log: true
    });
    const baseURL = "https://unpkg.com/@ffmpeg/core@0.12.4/dist/umd";
    ffmpeg.load({
      coreURL: await toBlobURL(`${baseURL}/ffmpeg-core.js`, "text/javascript"),
      wasmURL: await toBlobURL(
        `${baseURL}/ffmpeg-core.wasm`,
        "application/wasm",
      ),
    });


    const compose = async () => {
      const imageInput = document.getElementById('image-uploader');
      const videoInput = document.getElementById('video-uploader');
      const imageFile = imageInput.files[0];
      const videoFile = videoInput.files[0];

      if (!imageFile || !videoFile) {
        alert('Please upload both an image and a video file.');
        return;
      }

      await ffmpeg.load();
      ffmpeg.FS('writeFile', imageFile.name, await fetchFile(imageFile));
      ffmpeg.FS('writeFile', videoFile.name, await fetchFile(videoFile));

      await ffmpeg.run('-i', videoFile.name, '-i', imageFile.name, '-filter_complex', '[0:v]chromakey=0x00FF00:0.1:0.2[ckout];[1:v][ckout]overlay=(W-w)/2:(H-h)/2', '-pix_fmt', 'yuv420p', '-c:a', 'copy', 'output.mp4');

      const data = ffmpeg.FS('readFile', 'output.mp4');
      const video = document.getElementById('output-video');
      video.src = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
    };

    document.getElementById('compose').addEventListener('click', compose);
  </script>
</body>

</html>